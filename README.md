# **Тестовое задание для стажёра Backend (осенняя волна 2025)**

# Сервис назначения ревьюеров для Pull Request'ов

Условия задачи описаны в файле [TASK.md](./TASK.md).

## Quick Start

1. **клонируйте репозиторий**:
    ```bash
    git clone https://github.com/kxddry/avito-backend-internship-2025
    cd avito-backend-internship-2025
    ```

2. **запустите сервис**:
    ```bash
    docker-compose up --build
    ```

3. **профит**

Сервис будет доступен по адресу `http://localhost:8080`. 

Также будут доступны:
- **Prometheus**: `http://localhost:9090` - сбор метрик
- **Grafana**: `http://localhost:3000` - визуализация метрик (admin/admin)
- **Metrics endpoint**: `http://localhost:8080/metrics` - Prometheus метрики
- **pprof endpoints**: `http://localhost:8080/debug/pprof/` - профилирование

## Архитектура

Проект следует принципам чистой архитектуры:

- `cmd/app/` - точка входа приложения
- `cmd/stresser/` - стресс-тестер для нагрузочного тестирования
- `internal/api/` - HTTP обработчики и маршрутизация
- `internal/domain/` - бизнес-логика и интерфейсы
- `internal/service/` - реализация бизнес-логики
- `internal/storage/` - работа с БД и репозитории
- `pkg/` - переиспользуемые пакеты (метрики, логирование, middleware)

## Основные возможности

### API Endpoints

- `POST /team/add` - создание команды
- `GET /team/get` - получение команды
- `POST /teams/{team_name}/deactivate` - массовая деактивация команды (дополнительное задание)
- `POST /pullRequest/create` - создание PR с автоматическим назначением ревьюеров
- `POST /pullRequest/merge` - merge PR (идемпотентная операция)
- `POST /pullRequest/reassign` - переназначение ревьюера
- `POST /pullRequest/safeReassign` - безопасное переназначение неактивных ревьюеров (дополнительное задание)
- `POST /users/setIsActive` - установка статуса активности пользователя
- `GET /users/getReview` - получение списка PR пользователя
- `GET /stats` - статистика по пользователям, PR и командам (дополнительное задание)

### Метрики

Реализованы метрики согласно [METRICS.md](./METRICS.md):

- **HTTP метрики**: RPS, latency, статусы ответов
- **Доменные метрики**: создание PR, назначения ревьюеров, переназначения
- **Метрики инвариантов**: контроль корректности бизнес-логики
- **Метрики БД**: латенси запросов, ошибки

Метрики доступны через `/metrics` endpoint и визуализируются в Grafana.

### Профилирование

Доступны pprof endpoints для профилирования:
- CPU профиль: `http://localhost:8080/debug/pprof/profile?seconds=30`
- Memory профиль: `http://localhost:8080/debug/pprof/heap`
- Goroutines: `http://localhost:8080/debug/pprof/goroutine`

Для удобства профилирования:
```bash
make pprof
```

## Тестирование

### Unit тесты
```bash
make test-unit
```

### Integration тесты
```bash
make test-integration
```

### E2E тесты
```bash
make test-e2e
```

### Нагрузочное тестирование

Запуск стресс-тестера:
```bash
make stress
```

Или с настройками:
```bash
go run ./cmd/stresser -url http://localhost:8080 -duration 60s -workers 16
```

Стресс-тестер:
- Создает начальные данные (команды, пользователей)
- Генерирует реалистичную нагрузку на все эндпоинты
- Использует все доступные ядра процессора
- Выводит статистику каждые 5 секунд
- Показывает RPS и успешность запросов

## Линтеры

В проекте используются:
- `golangci-lint` - комплексный линтер
- `golint` - стандартный Go линтер

Проверить код:
```bash
golangci-lint run
golint ./...
```

## База данных

PostgreSQL 18 с миграциями через migrate/migrate.

Миграции применяются автоматически при запуске через docker-compose.

## Технологии

- **Go 1.25** - язык программирования
- **PostgreSQL 18** - база данных
- **Echo v4** - HTTP framework
- **oapi-codegen** - генерация кода из OpenAPI
- **Prometheus** - сбор метрик
- **Grafana** - визуализация метрик
- **Docker & Docker Compose** - контейнеризация

## Дополнительные задания

Все дополнительные задания выполнены:

- [x] Эндпоинт статистики (`GET /stats`)  
- [x] Нагрузочное тестирование (стресс-тестер в `cmd/stresser`)  
- [x] Массовая деактивация пользователей команды (`POST /teams/{name}/deactivate`)  
- [x] Безопасная переназначаемость открытых PR (`POST /pullRequest/safeReassign`)  
- [x] Интеграционное и E2E тестирование  
- [x] Конфигурация линтера (в файле .golangci.yml)  

## Performance

Сервис спроектирован с учетом требований:
- RPS: 5 (легко справляется с нагрузкой в разы выше)
- SLI времени ответа: 300 мс (p99 < 100 мс при умеренной нагрузке)
- SLI успешности: 99.9%

### Вопросы

#### Эта секция содержит вопросы, которые возникли у меня в процессе выполнения задания, а также мои ответы на них.

- **Может ли пользователь состоять в нескольких командах?**  
    Нет, пользователь может состоять только в одной команде.
    Сделано так, поскольку в реальных сценариях обычно пользователь привязан к одной команде, и это упрощает логику назначения ревьюверов.
- **Может ли команда менять своё название?**  
    Нет, команда не может менять своё название. 

    Это упрощает идентификацию команд и предотвращает возможные конфликты при переименовании.
- **Что происходит с PR, если его автора удаляют или деактивируют?**  
    PR остаётся в системе с текущим статусом и назначенными ревьюверами.
    Это позволяет сохранять историю изменений и назначений, даже если автор больше не активен.
    Поле is_active у пользователя становится false.

- **А что, если создадут команду, в которой есть пользователь, который был до этого в другой команде?**  
    Пользователь будет автоматически удалён из предыдущей команды и добавлен в новую.
    Это обеспечивает целостность данных и предотвращает дублирование пользователей в нескольких командах.

#### Плохая документация:
- **а что за 401 код в респонсе на setActive?**  
    я решил, что это ошибка в спецификации OpenAPI, т.к. не описана
    ни авторизация, ни код UNAUTHORIZED в enum кодов. поэтому 401 код просто не будет приходить. и токен приниматься тоже.
    блок securitySchemes отсутствует, код 401 невозможен, enum не содержит UNAUTHORIZED, поэтому принято решение создать без аутентификации. 
    кроме того, в остальных методах нет поля "is_admin" или подобного, которое бы указывало на наличие админских прав.
- **описание /team/add: создаёт или обновляет пользователей в команде**  
    здесь не сходится документация - "создаёт или обновляет пользователей" и "если команда с таким именем уже существует, возвращается ошибка".
    
  я решил, что, после создания команда будет иммутабельна через метод /team/add с team_name = old_name.
  для перемещения пользователя в другую команду нужно создать новую команду с новым именем, куда положим пользователя.
- **а что за AdminToken и UserToken?**  
  они не прописаны в спецификации. а в тех разделах, где они упомянуты, не описано, как их получить.
  я решил, что токены не нужны, т.к. в спецификации нет блока securitySchemes, нет поля "is_admin" или подобного, которое бы указывало на наличие админских прав.
  поэтому принято решение создать без аутентификации. (ну там выше было написано).
- **в описании /user/getReview: что, если пользователя нет?**  
    тогда логичнее всего вернуть 404. так и сделал